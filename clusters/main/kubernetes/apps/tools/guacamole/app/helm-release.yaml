---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: guacamole
  namespace: guacamole
spec:
  interval: 15m
  chart:
    spec:
      chart: guacamole
      version: 16.7.0
      sourceRef:
        kind: HelmRepository
        name: truecharts
        namespace: flux-system
      interval: 15m
  timeout: 5m
  maxHistory: 3
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  uninstall:
    keepHistory: false
  values:
    global:
      stopAll: false
    guacamole:
      general:
        EXTENSION_PRIORITY: "openid"
      openid:
        OPENID_AUTHORIZATION_ENDPOINT: "https://auth.${DOMAIN_2}/api/oidc/authorization?state=1234abcedfdhf"
        OPENID_JWKS_ENDPOINT: "https://auth.${DOMAIN_2}/jwks.json"
        OPENID_ISSUER: "https://auth.${DOMAIN_2}"
        OPENID_CLIENT_ID: "guacamole"
        OPENID_REDIRECT_URI: "https://guacamole.${DOMAIN_2}"
        OPENID_USERNAME_CLAIM_TYPE: preferred_username
        OPENID_GROUPS_CLAIM_TYPE: groups
        OPENID_SCOPE: openid profile groups email
        OPENID_ALLOWED_CLOCK_SKEW: 30
        OPENID_MAX_TOKEN_VALIDITY: 300
        OPENID_MAX_NONCE_VALIDITY: 300
    ingress:
      main:
        enabled: true
        ingressClassName: internal
        hosts:
          - host: guacamole.${DOMAIN_2}
        integrations:
          certManager:
            enabled: true
            certificateIssuer: general-le-prod
    configmap:
      test:
        enabled: true
        data:
          test.txt: |
            # Single service URL (respects expandName and primary)
            {{- $svcName := "guacd" -}}           # Change to "guacd" or any other service
            {{- $portName := "guacd" -}}

            {{- $svc := index .Values.service $svcName -}}
            {{- $port := index $svc.ports $portName -}}

            {{- $fullname := include "tc.v1.common.lib.chart.names.fullname" $ -}}
            {{- $objectName := $svcName -}}

            {{- $expandName := (include "tc.v1.common.lib.util.expandName" (dict "rootCtx" $ "objectData" $svc "name" $svcName "caller" "Service" "key" "service")) -}}
            {{- if eq $expandName "true" -}}
              {{- $objectName = $fullname -}}
            {{- end -}}

            {{- if and (eq $expandName "true") (not $svc.primary) -}}
              {{- $objectName = printf "%s-%s" $fullname $svcName -}}
            {{- end -}}
            
            endpoints:
              - name: {{ .Release.Namespace }}
                group: tools
                url: '{{ printf "%s://%s.%s.svc.cluster.local:%v" (default "http" $port.protocol) $objectName .Release.Namespace $port.port }}'
                interval: 1m
                ui:
                  hide-url: true
                  hide-hostname: true
                conditions:
                  - "[CONNECTED] == true"
                alerts:
                  - type: discord
                    description: "healthcheck failed"
                    send-on-resolved: true

            
      gatus:
        enabled: true
        labels:
          gatus.io/enabled: "true"
        data:
          config.yaml: |
            endpoints:
              - name: {{ .Release.Namespace }}
                group: tools
                url: '{{ printf "%s://%s.%s.svc.cluster.local:%v" .Values.service.main.ports.main.protocol .Release.Name .Release.Namespace .Values.service.main.ports.main.port }}'
                interval: 1m
                ui:
                  hide-url: true
                  hide-hostname: true
                conditions:
                  - "[CONNECTED] == true"
                alerts:
                  - type: discord
                    description: "healthcheck failed"
                    send-on-resolved: true
