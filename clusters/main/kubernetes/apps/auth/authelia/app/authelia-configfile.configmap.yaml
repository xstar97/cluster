apiVersion: v1
kind: ConfigMap
metadata:
  name: authelia-configfile
  namespace: authelia
data:
  configuration.yaml: |
    server:
      buffers:
        read: 16384
        write: 16384
    theme: dark
    totp:
      issuer: ${DOMAIN_2}
    session:
      cookies:
        - domain: ${DOMAIN_2}
          authelia_url: https://auth.${DOMAIN_2}
    authentication_backend:
      # lldap setup
      # https://github.com/lldap/lldap/blob/main/example_configs/authelia_config.yml
      ldap:
        address: ${LLDAP_URL_CLUSTER}
        tls:
          server_name: lldap.${DOMAIN_2}
        base_dn: ${LLDAP_LDAP_BASE_DN}
        attributes:
          username: uid
        additional_users_dn: ou=people
        users_filter: (&(|({username_attribute}={input})({mail_attribute}={input}))(objectClass=person))
        additional_groups_dn: ou=groups
        groups_filter: (member={dn})
        user: ${LLDAP_LDAP_PWDMANAGER_USER}
        password: ${LLDAP_LDAP_PWDMANAGER_PASS}
    notifier:
      smtp:
        address: 'smtp://${SMTP_GMAIL_HOST}:${SMTP_GMAIL_PORT}'
        username: ${SMTP_GMAIL_EMAIL}
        password: ${SMTP_GMAIL_PASS_AUTHELIA}
        sender: auth@${DOMAIN_2}
        startup_check_address: auth@${DOMAIN_2}
        disable_html_emails: true
        tls:
          server_name: ${SMTP_GMAIL_HOST}
    password_policy:
      standard:
        enabled: true
        min_length: 10
        max_length: 0
        require_uppercase: true
        require_lowercase: true
        require_number: true
        require_special: true
    access_control:
      rules:
        - domain:
            - ${DOMAIN_2}
            - '*.${DOMAIN_2}'
          policy: one_factor
          subject:
            - 'group:lldap_admin'
    identity_providers:
      oidc:
        claims_policies:
          all:
            id_token: ['groups', 'email', 'email_verified', 'alt_emails', 'preferred_username', 'name']
          stirlingpdf:
            id_token: ['preferred_username']
        hmac_secret: {{ secret "/config/secret/hmac_secret" }}
        jwks:
          - key: |
              {{ secret "/config/secret/jwks_key.pem" | mindent 10 "|" | msquote }}
        authorization_policies:
          romm:
            default_policy: 'deny'
            rules:
              - policy: 'one_factor'
                subject: 'group:lldap_admin'
              - policy: 'one_factor'
                subject: 'group:lldap_romm'
          grafana:
            default_policy: 'deny'
            rules:
              - policy: 'one_factor'
                subject: 'group:lldap_admin'
              - policy: 'one_factor'
                subject: 'group:lldap_grafana'
          stirlingpdf:
            default_policy: 'deny'
            rules:
              - policy: 'one_factor'
                subject: 'group:lldap_admin'
              - policy: 'one_factor'
                subject: 'group:lldap_stirlingpdf'
        clients:
          - client_id: "romm" # read above for how generate
            client_name: "RomM" # will be displayed in Authelia to users
            client_secret:  '{{ secret "/config/secret/clients_romm_client_secret" }}'
            public: false
            authorization_policy: "romm" # or one_factor, depending on your needs
            grant_types:
                - authorization_code
            redirect_uris:
                - "https://romm.${DOMAIN_2}/api/oauth/openid"
            scopes:
                - "openid"
                - "email"
                - "profile"
            userinfo_signed_response_alg: "none"
            token_endpoint_auth_method: "client_secret_basic"
            claims_policy: "all"
          - client_id: 'grafana'
            client_name: 'Grafana'
            client_secret: {{ secret "/config/secret/clients_grafana_client_secret" }}
            public: false
            authorization_policy: 'grafana'
            require_pkce: true
            pkce_challenge_method: 'S256'
            redirect_uris:
              - 'https://grafana.${DOMAIN_2}/login/generic_oauth'
            scopes:
              - 'openid'
              - 'profile'
              - 'groups'
              - 'email'
            response_types:
              - 'code'
            grant_types:
              - 'authorization_code'
            access_token_signed_response_alg: 'none'
            userinfo_signed_response_alg: 'none'
            token_endpoint_auth_method: 'client_secret_basic'
            claims_policy: "all"
          - client_id: 'stirlingpdf'
            client_name: 'Stirling-PDF'
            client_secret: {{ secret "/config/secret/clients_stirlingpdf_client_secret" }}
            public: false
            authorization_policy: 'stirlingpdf'
            require_pkce: false
            pkce_challenge_method: ''
            redirect_uris:
              - 'https://stirlingpdf.example.com/login/oauth2/code/oidc'
            scopes:
              - 'openid'
              - 'profile'
              - 'groups'
              - 'email'
            response_types:
              - 'code'
            grant_types:
              - 'authorization_code'
            access_token_signed_response_alg: 'none'
            userinfo_signed_response_alg: 'none'
            token_endpoint_auth_method: 'client_secret_basic'
            claims_policy: 'stirlingpdf'