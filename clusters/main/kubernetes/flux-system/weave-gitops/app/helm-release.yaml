---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: weave-gitops
  namespace: flux-system
  annotations:
    reloader.stakater.com/auto: "true"
spec:
  interval: 15m
  chart:
    spec:
      chart: app-template
      version: 15.13.7
      sourceRef:
        kind: HelmRepository
        name: truecharts
        namespace: flux-system
      interval: 15m
  timeout: 20m
  maxHistory: 3
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  uninstall:
    keepHistory: false
  values:
    global:
      stopAll: false
    image:
      repository: ghcr.io/weaveworks/charts/weave-gitops
      pullPolicy: IfNotPresent
      tag: 4.0.36
    securityContext:
      readOnlyRootFilesystem: false
    service:
      main:
        ports:
          main:
            port: 9001
      metrics:
        enabled: "{{ .Values.metrics.main.enabled }}"
        ports:
          metrics:
            enabled: true
            port: 2112
    ingress:
      main:
        enabled: true
        ingressClassName: "internal"
        annotations:
          cert-manager.io/cluster-issuer: general-le-prod
          cert-manager.io/private-key-rotation-policy: Always
        hosts:
          - host: gitops.${DOMAIN_2}
            paths:
              - path: /
                pathType: Prefix
        integrations:
          nginx:
            enabled: true
          certManager:
            enabled: true
            certificateIssuer: general-le-prod
    adminUser:
      create: true
      username: admin
      passwordHash: "$2a$10$zbuAGqz3.4YAk4NPiDMwVOzRJu1QwzAUkDxYDcg3c3L74xKDXf.fi"
    networkPolicy:
      create: false
    rbac:
      main:
        enabled: true
        primary: true
        clusterWide: true
        impersonationResourceNames: ["admin"]
        rules:
          - apiGroups: ["infra.contrib.fluxcd.io"]
            resources: ["terraforms"]
            verbs: ["get", "list", "patch"]

    # -- The service account the pods will use to interact with the Kubernetes API
    serviceAccount:
      main:
        enabled: true
        primary: true

    podOptions:
      automountServiceAccountToken: true

    metrics:
      enabled: true
      main:
        enabled: true
        type: "servicemonitor"
        endpoints:
          - port: metrics
            path: /metrics
        targetSelector: metrics
        prometheusRule:
          enabled: false