apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: netbootxyz
  namespace: netbootxyz
spec:
  interval: 5m
  chart:
    spec:
      chart: netbootxyz
      version: 7.9.0
      sourceRef:
        kind: HelmRepository
        name: truecharts
        namespace: flux-system
      interval: 5m
  install:
    createNamespace: true
    crds: CreateReplace
    remediation:
      retries: 3
  upgrade:
    crds: CreateReplace
    remediation:
      retries: 3
  values:
    global:
      stopAll: false
    service:
      main:
        ports:
          main:
            protocol: http
            # targetPort: 3000
            port: 3000
      assets:
        enabled: true
        ports:
          assets:
            enabled: true
            protocol: http
            # targetPort: 80
            port: 80
      tftp:
        enabled: true
        ports:
          tftp:
            enabled: true
            port: 69
            protocol: udp
            # targetPort: 69
    workload:
      main:
        podSpec:
          containers:
            main:
              env:
                WEB_APP_PORT: "{{ .Values.service.main.ports.main.port }}"
                NGINX_PORT: "{{ .Values.service.main.ports.main.port }}"
    ingress:
      main:
        enabled: true
        ingressClassName: "internal"
        hosts:
          - host: netbootxyz.${DOMAIN_2}
            paths:
              - path: /
                pathType: Prefix
        integrations:
          nginx:
            enabled: true
          certManager:
            enabled: true
            certificateIssuer: general-le-prod
      assets:
        enabled: true
        # primary: true
        ingressClassName: internal
        # targetSelector:
        #   assets: assets
        hosts:
          - host: assets.netbootxyz.${DOMAIN_2}
        integrations:
          nginx:
            enabled: true
          certManager:
            enabled: true
            certificateIssuer: general-le-prod

    persistence:
      config:
        enabled: true
        volsync:
          - name: config
            type: restic
            credentials: cf-restic
            dest:
              enabled: true
            src:
              enabled: true
      assets:
        enabled: true
        volsync:
          - name: config
            type: restic
            credentials: cf-restic
            dest:
              enabled: true
            src:
              enabled: true
