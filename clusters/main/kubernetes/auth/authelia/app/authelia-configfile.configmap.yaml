apiVersion: v1
kind: ConfigMap
metadata:
  name: authelia-configfile
  namespace: authelia
data:
  configuration.yaml: |
    session:
      cookies:
        - domain: "${DOMAIN_2}"
          authelia_url: "https://auth.${DOMAIN_2}"
    access_control:
      rules:
        - domain:
            - "${DOMAIN_2}"
            - "*.${DOMAIN_2}"
          policy: one_factor
          subject:
            - 'group:lldap_admin'            
    identity_providers:
      oidc:
        lifespans:
          access_token: 1h
          authorize_code: 1m
          id_token: 1h
          refresh_token: 90m
        enable_client_debug_messages: true
        enforce_pkce: public_clients_only
        cors:
          endpoints:
            - authorization
            - pushed-authorization-request
            - token
            - revocation
            - introspection
            - userinfo
          allowed_origins_from_client_redirect_uris: true
        claims_policies:
          default:
            id_token: ['rat', 'groups', 'email', 'email_verified', 'alt_emails', 'preferred_username', 'name']
          romm:
            id_token: ['email', 'email_verified', 'alt_emails', 'preferred_username', 'name']            
          grafana:
            id_token: ['email', 'name', 'groups', 'preferred_username']            
          vaultwarden:
              id_token: ['email', 'groups', 'profile']     
          audiobookrequest:
            id_token: ['groups', 'profile', 'email']     
          booklore:
            id_token: ['email', 'preferred_username', 'name']
        hmac_secret: {{ secret "/config/secret/hmac_secret" }}
        jwks:
          - key: |
              {{ secret "/config/secret/jwks_key.pem" | mindent 10 "|" | msquote }}
        authorization_policies:
          admin:
            default_policy: 'deny'
            rules:
              - policy: 'one_factor'
                subject: 'group:lldap_admin'
          romm:
            default_policy: 'deny'
            rules:
              - policy: 'one_factor'
                subject: 'group:lldap_admin'
              - policy: 'one_factor'
                subject: 'group:lldap_romm'
          grafana:
            default_policy: 'deny'
            rules:
              - policy: 'one_factor'
                subject: 'group:lldap_admin'
              - policy: 'one_factor'
                subject: 'group:lldap_grafana'
          paperless:
            default_policy: 'deny'
            rules:
              - policy: 'one_factor'
                subject: 'group:lldap_admin'
              - policy: 'one_factor'
                subject: 'group:lldap_paperless'
          actual:
            default_policy: 'deny'
            rules:
              - policy: 'one_factor'
                subject: 'group:lldap_admin'
              - policy: 'one_factor'
                subject: 'group:lldap_actual'
          jellyseerr:
            default_policy: 'deny'
            rules:
              - policy: 'one_factor'
                subject: 'group:lldap_admin'
              - policy: 'one_factor'
                subject: 'group:lldap_jellyseerr'
          vaultwarden:
            default_policy: 'deny'
            rules:
              - policy: 'one_factor'
                subject: 'group:lldap_admin'
              - policy: 'one_factor'
                subject: 'group:lldap_vaultwarden'
          wallos:
            default_policy: 'deny'
            rules:
              - policy: 'one_factor'
                subject: 'group:lldap_admin'
              - policy: 'one_factor'
                subject: 'group:lldap_wallos'
          audiobookrequest:
            default_policy: 'deny'
            rules:
              - policy: 'one_factor'
                subject: 'group:lldap_admin'
              - policy: 'one_factor'
                subject: 'group:trusted'
              - policy: 'one_factor'
                subject: 'group:lldap_audiobookrequest'
          booklore:
            default_policy: 'deny'
            rules:
              - policy: 'one_factor'
                subject: 'group:lldap_admin'
              - policy: 'one_factor'
                subject: 'group:lldap_booklore'
        clients:
          - client_id: "romm" # read above for how generate
            client_name: "RomM" # will be displayed in Authelia to users
            client_secret:  {{ secret "/config/secret/clients_romm_client_secret" }}
            public: false
            authorization_policy: "romm" # or one_factor, depending on your needs
            grant_types:
                - authorization_code
            redirect_uris:
                - "https://romm.${DOMAIN_2}/api/oauth/openid"
            claims_policy: "romm"
            scopes:
                - "openid"
                - "email"
                - "profile"
            userinfo_signed_response_alg: "none"
            token_endpoint_auth_method: "client_secret_basic"
          - client_id: 'grafana'
            client_name: 'Grafana'
            client_secret: {{ secret "/config/secret/clients_grafana_client_secret" }}
            public: false
            authorization_policy: 'grafana'
            require_pkce: true
            pkce_challenge_method: 'S256'
            redirect_uris:
              - 'https://grafana.${DOMAIN_2}/login/generic_oauth'
            scopes:
              - 'openid'
              - 'profile'
              - 'groups'
              - 'email'
            response_types:
              - 'code'
            grant_types:
              - 'authorization_code'
            access_token_signed_response_alg: 'none'
            userinfo_signed_response_alg: 'none'
            token_endpoint_auth_method: 'client_secret_basic'
            claims_policy: "grafana"
          - client_id: 'paperless'
            client_name: 'Paperless'
            client_secret: {{ secret "/config/secret/clients_paperless_client_secret" }}
            public: false
            authorization_policy: 'paperless'
            require_pkce: true
            pkce_challenge_method: 'S256'
            redirect_uris:
              - 'https://paperless.${DOMAIN_2}/accounts/oidc/authelia/login/callback/'
            scopes:
              - 'openid'
              - 'profile'
              - 'email'
              - 'groups'
            response_types:
              - 'code'
            grant_types:
              - 'authorization_code'
            access_token_signed_response_alg: 'none'
            userinfo_signed_response_alg: 'none'
            token_endpoint_auth_method: 'client_secret_basic'
          - client_id: 'actual-budget'
            client_name: 'Actual Budget'
            client_secret: {{ secret "/config/secret/clients_actual_budget_client_secret" }}
            public: false
            authorization_policy: 'actual'
            require_pkce: false
            pkce_challenge_method: ''
            redirect_uris:
              - 'https://actual.${DOMAIN_2}/openid/callback'
            scopes:
              - 'openid'
              - 'profile'
              - 'groups'
              - 'email'
            response_types:
              - 'code'
            grant_types:
              - 'authorization_code'
            access_token_signed_response_alg: 'none'
            userinfo_signed_response_alg: 'none'
            token_endpoint_auth_method: 'client_secret_basic'
          - client_id: 'jellyseerr'
            client_name: 'Jellyseerr'
            client_secret: {{ secret "/config/secret/clients_jellyseerr_client_secret" }}
            public: false
            authorization_policy: 'jellyseerr'
            redirect_uris:
              - 'https://jellyseerr.${DOMAIN_2}/login/oidc/callback/authelia'
            scopes:
              - 'openid'
              - 'email'
              - 'profile'
              - 'groups'
            token_endpoint_auth_method: 'client_secret_post'
          - client_id: 'vaultwarden'
            client_name: 'vaultwarden'
            client_secret: {{ secret "/config/secret/clients_vaultwarden_client_secret" }}
            public: false
            authorization_policy: 'vaultwarden'
            require_pkce: true
            redirect_uris:
              - 'https://vaultwarden.${DOMAIN_2}/identity/connect/oidc-signin'
            scopes:
              - 'email'
              - 'profile'
              - 'openid'
              - 'offline_access'
            claims_policy: "default"
          - client_id: 'wallos'
            client_name: 'wallos'
            client_secret: {{ secret "/config/secret/clients_wallos_client_secret" }}
            public: false
            authorization_policy: 'wallos'
            pre_configured_consent_duration: "1y"
            redirect_uris:
              - 'https://wallos.${DOMAIN_2}/'
            grant_types:
              - "refresh_token"
              - "authorization_code"
            response_types:
              - "code"
            response_modes:
              - "form_post"
              - "query"
              - "fragment"
            scopes:
              - 'openid'
              - 'email'
              - 'profile'
              - 'groups'
              - 'offline_access'
            token_endpoint_auth_method: 'client_secret_post'
            userinfo_signed_response_alg: "none"
            claims_policy: "default"
          - client_id: audiobookrequest
            client_name: 'audiobookrequest' 
            client_secret: {{ secret "/config/secret/clients_abr_client_secret" }}
            public: false
            authorization_policy: audiobookrequest
            require_pkce: true
            pkce_challenge_method: 'S256'
            access_token_signed_response_alg: 'none'
            userinfo_signed_response_alg: 'none'
            token_endpoint_auth_method: "client_secret_basic"
            scopes:
              - openid
              - groups
              - profile
              - email
            redirect_uris:
              - 'https://abr.${DOMAIN_2}/auth/oidc'
            grant_types:
              - authorization_code
            pre_configured_consent_duration: 1m
            consent_mode: implicit # self hosted
            response_types:
              - code
            claims_policy: "audiobookrequest"
          - client_id: 'booklore'
            client_name: 'BookLore'
            public: true
            authorization_policy: 'booklore'
            claims_policy: booklore
            # consent_mode: implicit
            require_pkce: true
            pkce_challenge_method: 'S256'
            redirect_uris:
              - 'https://booklore.${DOMAIN_2}/api/oidc'
              - 'https://booklore.${DOMAIN_2}/oauth2-callback'
            scopes:
              - 'openid'
              - 'offline_access'
              - 'profile'
              - 'email'
            response_types:
              - 'code'
            grant_types:
              - 'authorization_code'
              - 'refresh_token'
            access_token_signed_response_alg: 'none'
            userinfo_signed_response_alg: 'none'
            token_endpoint_auth_method: 'none'
