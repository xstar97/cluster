apiVersion: helm.toolkit.fluxcd.io/v2beta2
kind: HelmRelease
metadata:
  name: not-used
spec:
  interval: 5m
  values:
    configmap:
      gatus:
        enabled: true
        labels:
          gatus.io/enabled: "true"
        data:
          config.yaml: |
            {{- $svcName := default "main" "${SVC}" -}}
            {{- $svc := index .Values.service $svcName -}}
            {{- $port := index $svc.ports $svcName -}}

            {{- $protocol := default "http" "${PROT}" -}}
            {{- if not (empty $port.protocol) -}}
            {{- $protocol = $port.protocol -}}
            {{- end -}}

            {{- $fullname := include "tc.v1.common.lib.chart.names.fullname" $ -}}
            {{- $objectName := $svcName -}}

            {{- $expandName := include "tc.v1.common.lib.util.expandName" (dict "rootCtx" $ "objectData" $svc "name" $svcName "caller" "Service" "key" "service") -}}
            {{- if eq $expandName "true" -}}
            {{- $objectName = $fullname -}}
            {{- end -}}

            {{- if and (eq $expandName "true") (not $svc.primary) -}}
            {{- $objectName = printf "%s-%s" $fullname $svcName -}}
            {{- end -}}

            {{- $internalUrl := printf "%s://%s.%s.svc.cluster.local:%v" $protocol $objectName .Release.Namespace $port.port -}}

            endpoints:
              - name: {{ .Release.Namespace }}
                group: "${GROUP}"
                url: {{ $internalUrl }}
                interval: 1m
                ui:
                  hide-url: true
                  hide-hostname: true
                client:
                  insecure: true
                  timeout: 30s
                conditions:
                  - "[CONNECTED] == true"
                alerts:
                  - type: discord
                    description: "healthcheck failed"
                    send-on-resolved: true
